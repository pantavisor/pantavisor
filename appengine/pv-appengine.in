#!/bin/bash

set -x
set -e

interrupt='false'

usage() {
	echo "Usage: $0 [options]"
	echo "Run Pantavisor in an existing OS"
	echo "options:"
	echo "       -h         show help"
	echo "       -i         interrupt automated reboot and wait for user confirmation"
	echo "       -c CMDLINE additional cmdline arguments (incl. legacy configs)"
	echo "       -e ENVS envs to set (incl. new config format)"
}

exec_run() {
	pv_trying=""
	while true
	do
		# load boot info
		revs=`cat "@PV_INSTALL_FULL_STORAGEDIR@/boot/uboot.txt"`
		pv_rev=`echo "$revs" | awk -v FS="(pv_rev=|pv_try=)" '{print $2}'`
		pv_try=`echo "$revs" | awk -v FS="(pv_rev=|pv_try=)" '{print $3}'`

		# set boot info
		if [ -n "$pv_try" ]; then
			if [ -n "$pv_trying" ] && [ "$pv_trying" = "$pv_try" ]; then
				pv_trying=""
			else
				pv_trying="$pv_try"
				pv_rev="$pv_try";
			fi
		fi

		cmdline_file=`cat "@PV_INSTALL_FULL_STORAGEDIR@/boot/cmdline.txt"`

		# exec Pantavisor
		/usr/bin/unshare --cgroup @CMAKE_INSTALL_FULL_BINDIR@/pantavisor --config @CMAKE_INSTALL_FULL_SYSCONFDIR@/pantavisor-appengine.config --cmdline "pv_rev=$pv_rev pv_try=$pv_try $cmdline_file $cmdline"

		# lets cosume all buffered input first
		while read -d "" -t 0.01; do
			:
		done

		# wait for user input or continue
		if [ "$interrupt" = 'true' ]
		then
			if read -t 5 -p "INFO: Will restart Pantavisor in 5 sec. Press ENTER to abort"; then
				echo "INFO: Exiting..."
				break
			fi
		fi
	done
}

# parse options
while [ $# -gt 0 ]; do
	case "$1" in
		-h)
			usage; exit 0
			;;
		-i)
			interrupt='true'
			;;
		-c)
			shift
			cmdline="$1"
			;;
		-e)
			shift
			envs="$1"
			;;
		*)
			break
	esac
	shift
done

# uninstall Pantavisor
exec_run
