#!/bin/bash

source @CMAKE_INSTALL_FULL_DATADIR@/@PROJECT_NAME@/pvtest/utils

usage() {
	echo ""
	echo "Usage: $0 <test-path> <interactive> <manual> <overwrite> <verbose> <netsim>"
	echo ""
}

parse_test() {
	json_path="$test_path/test.json"
	if [ ! -e "$json_path" ]; then
		echo "Error: '$json_path' not found"
		exit 1
	fi

	description=$(jq -r '.description' "$json_path")
	cmdline=$(jq -r '.setup.cmdline' "$json_path")
	pantavisor_config=$(jq -r '.setup."pantavisor.config"' "$json_path")
	pvs=$(jq -r '.setup.pvs' "$json_path")
	control_container=$(jq -r '.setup.containers.control' "$json_path")
	tarballs=$(jq -r '.setup.containers.tarballs[]' "$json_path")
	ready_script=$(jq -r '.setup."ready-script"' "$json_path")
	self_claim=$(jq -r '.setup."self-claim"' "$json_path")
	test_script=$(jq -r '."test-script"' "$json_path")
}

cleanup() {
	kill $(jobs -p) 2>/dev/null
}
trap cleanup EXIT

initial_setup() {
	if ! cat /proc/mounts | awk '{ print $2}' | grep -q '^@PV_INSTALL_FULL_STORAGEDIR@$'; then
		echo "ERROR: @PV_INSTALL_FULL_STORAGEDIR@ must be a mountpoint."
		sleep 10
		exit 1
	fi

	if ! [ -f @PV_INSTALL_FULL_STORAGEDIR@/.created ]; then
		cp -a @PV_INSTALL_FULL_SKELDIR@/* @PV_INSTALL_FULL_STORAGEDIR@/
		touch @PV_INSTALL_FULL_STORAGEDIR@/.created
	fi

	if [ ! -f "$test_path/$test_script" ]; then
		echo "Error: '$test_path/$test_script' does not exist"
		exit 1
	fi

	if [ "$netsim" = "true" ]; then
		wait_for_status "ip link set wlan1 name wlan0" 0 5 > /dev/null 2>&1
		if [ $? -ne 0 ]; then
			echo "Error: could not setup wlan0 interface for tester"
			exit 1
		fi
	fi

	if [ -n "$pantavisor_config" ]; then
		cp "$test_path/$pantavisor_config" "@CMAKE_INSTALL_FULL_SYSCONFDIR@/pantavisor-appengine.config"
	fi

	if [ -n "$pvs" ]; then
		rm -f @CMAKE_INSTALL_FULL_SYSCONFDIR@/pantavisor/pvs/trust/*
		find $test_path/$pvs -exec tar -xf '{}' -C @CMAKE_INSTALL_FULL_SYSCONFDIR@/pantavisor/pvs/trust/ --strip-components=1 \;
	fi

	# lets be double sure we start from fresh revision
	pvtx abort
	pvtx begin empty @PV_INSTALL_FULL_STORAGEDIR@/objects
	# copy rev to pvtxdir
	mkdir -p @PV_INSTALL_FULL_PVTXDIR@
	for tarball in $tarballs; do
		if [ ! -e "$test_path/$tarball" ]; then echo "Error: '$test_path/$tarball' does not exist"; exit 1; fi
		cp -f "$test_path/$tarball" @PV_INSTALL_FULL_PVTXDIR@/
	done
	rm -f @PV_INSTALL_FULL_STORAGEDIR@/.pvtx-done
}

exec_interactive() {
	echo ""
	echo "Welcome to Pantavisor appengine!"
	echo ""

	if [ "$manual" = "true" ]; then
		echo "Info: Pantavisor is not running."
		echo "To run Pantavisor with stdout logs:"
		echo "pv-appengine -c \"PV_LOG_SERVER_OUTPUTS=filetree,stdout\""
		echo ""
	elif [ "$pv_ready" = "false" ]; then
		echo "Warn: Pantavisor not responding or not ready."
	else
		echo "Info: Pantavisor is already running."
		echo "To run your test:"
		echo "$test_path/$test_script"
		echo ""
	fi

	sh -c "bash"
}
stop_pv() {
	if [ -f "@CMAKE_INSTALL_FULL_RUNSTATEDIR@/pantavisor/pv/device-id" ]; then
		device_id=`cat @CMAKE_INSTALL_FULL_RUNSTATEDIR@/pantavisor/pv/device-id`
	fi
	if [ "$self_claim" = "true" ] && [ -n "$device_id" ] && [ -n "$PH_USER" ] && [ -n "$PH_PASS" ]; then
		pvr -u "$PH_USER" -p "$PH_PASS" login > /dev/null 2>&1
		pvr delete -y $device_id
	fi

	local pv_appengine_pid=$(ps | grep " pv-appengine$" | awk 'NR==1 {print $1}')
	if [ -n "$pv_appengine_pid" ]; then
		kill "$pv_appengine_pid"
	fi

	local pv_pid=$(ps | grep " pantavisor$" | awk 'NR==1 {print $1}')
	if [ -n "$pv_pid" ]; then
		eval "pventer -c $control_container pvcontrol commands poweroff" > /dev/null 2>&1
		wait_for_process " pantavisor$" "120" "-d"
			if [ $? -ne 0 ]; then
				echo "Warn: Pantavisor still running. Shutting it down..."
				kill "$pv_pid"
				wait_for_process " pantavisor$" "30" "-d"
				if [ $? -ne 0 ]; then
					echo "Error: Pantavisor still running. Exiting..."
					kill -SIGKILL "$pv_pid"
					pv_ready="false"
				fi
			fi
	fi
}

int_handler() {
	echo "Debug: Stopping Pantavisor...."
	stop_pv
	exit 2
}

start_pv() {
	pv_cmd="pv-appengine -c \"$cmdline\""

	if [ "$verbose" = "false" ]; then
		eval "$pv_cmd > /dev/null 2>&1 &"
	else
		eval "$pv_cmd &"
	fi

	trap 'int_handler' INT

	wait_for_process " pantavisor$" "30" "-a"
	if [ $? != 0 ]; then
	echo "Error: timed out waiting for Pantavisor PID"
		return
	fi

	if [ -n "$ready_script" ]; then
		if [ "$verbose" = "false" ]; then
			sh -c ". @CMAKE_INSTALL_FULL_DATADIR@/@CMAKE_PROJECT_NAME@/pvtest/utils \"$test_path/$ready_script\"" > /dev/null 2>&1
		else
			sh -c ". @CMAKE_INSTALL_FULL_DATADIR@/@CMAKE_PROJECT_NAME@/pvtest/utils \"$test_path/$ready_script\""
		fi
	fi

	wait_for_value "pventer -c $control_container pvcontrol devmeta ls | jq -r .'[\"pantavisor.status\"]'" "READY" "120"
	if [ $? != 0 ]; then
	echo "Error: timed out waiting for pantavisor.status READY"
	else
		pv_ready="true"
	fi

	wait_for_status "LD_LIBRARY_PATH=/lib:/usr/lib curl -s X GET http://localhost:12368/cgi-bin/pvtx/status > /dev/null 2>&1" 0 120
	if [ $? -ne 0 ]; then
		echo "Error: timed out waiting for $control_container pvr endpoint to be online"
		stop_pv
		exit 1
	fi

	if [ "$self_claim" = "true" ]; then
		if [ -z "$PH_USER" ] || [ -z "$PH_PASS" ]; then
			echo "Error: you need to set PH_USER and PH_PASS to execute the test"
			stop_pv
			exit 1
		fi
		pvr -u "$PH_USER" -p "$PH_PASS" login > /dev/null 2>&1

		wait_for_pantahub_state "$control_container" "claim"

		device_id=`cat @CMAKE_INSTALL_FULL_RUNSTATEDIR@/pantavisor/pv/device-id`
		challenge=`cat @CMAKE_INSTALL_FULL_RUNSTATEDIR@/pantavisor/pv/challenge`

		pvr claim -c "$challenge" "$device_id"

		wait_for_pantahub_state "$control_container" "idle"
	fi
}

exec_test() {
	if [ "$pv_ready" = "false" ]; then
		return
	fi

	script_path="$test_path/$test_script"
	tmp_script_path=
	if [ "$overwrite" = "true" ]; then
		tmp_script_path=$(mktemp /tmp/pv_appengine_script.XXXXXX)
		sed '5iset -x' "$test_path/$test_script" > "$tmp_script_path"
		script_path="$tmp_script_path"
		chmod +x "$tmp_script_path"
	fi

	tmp_out_path=$(mktemp /tmp/pv_appengine_output.XXXXXX)
	# we use script to get stdout and stderr in the same order we do in console
	script -q -c "sh -c \". @CMAKE_INSTALL_FULL_DATADIR@/@CMAKE_PROJECT_NAME@/pvtest/utils && $script_path\"" > $tmp_out_path 2>&1
	output=$(cat "$tmp_out_path")
	if [ "$overwrite" = "true" ]; then
		echo "$output" > $test_path/output
		rm -f "$tmp_script_path"
	fi
}

eval_test() {
	if [ "$pv_ready" = "false" ]; then
		stop_pv
		exit 1
	fi

	if [ "$overwrite" != "true" ]; then
		diff <(grep -vE '^(\+|\$)' $test_path/output) <(grep -vE '^(\+|\$)' "$tmp_out_path")
		if [ $? -ne 0 ]; then
			stop_pv
			exit 1
		fi
		rm -f "$tmp_script_path"
	fi
}


test_path=${1:-$TEST_PATH}
interactive=${2-$INTERACTIVE}
manual=${3:-$MANUAL}
overwrite=${4:-$OVERWRITE}
verbose=${5:-$VERBOSE}
netsim=${6:-$NETSIM}

if [ -z "$test_path" ] || [ -z "$interactive" ] || [ -z "$manual" ] || [ -z "$overwrite" ] || [ -z "$verbose" ] || [ -z "$netsim" ]; then
	echo "Error: missing arguments / envs"
	usage
fi

if [ "$verbose" = "true" ]; then set -x; fi

description=
cmdline=
pantavisor_config=
pvs=
control_container=
tarballs=
ready_script=
self_claim=
test_script=

parse_test

initial_setup

pv_ready="false"

if [ "$manual" = "false" ]; then
	start_pv
fi

if [ "$interactive" = "true" ]; then
	exec_interactive
fi

tmp_out_path=

if [ "$interactive" = "false" ]; then
	exec_test
fi

stop_pv

if [ "$interactive" = "false" ]; then
	eval_test
fi
